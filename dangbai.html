<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>ÄÄƒng bÃ i - Cáº£nh giÃ¡c cÃ¹ng chÃºng em</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <h1>ğŸ“ GÃ³c BÃ¡o chÃ­ há»c sinh</h1>
    <p>Chia sáº» thÃ´ng tin vÃ  tuyÃªn truyá»n</p>
  </header>

  <nav>
    <a href="index.html">Trang chá»§</a>
    <a href="chieutro.html">Thá»§ Ä‘oáº¡n</a>
    <a href="5khong5nen.html">5 KHÃ”NG - 5 NÃŠN</a>
    <a href="phanung.html">Pháº£n á»©ng nhanh</a>
    <a href="sangtao.html">SÃ¡ng táº¡o</a>
    <a href="tracnghiem.html">Tráº¯c nghiá»‡m</a>
    <a href="tuongtac.html">TÆ°Æ¡ng tÃ¡c</a>
    <a href="dangbai.html">ÄÄƒng bÃ i</a>
  </nav>

  <section>
    <!-- ÄÄƒng nháº­p -->
    <div class="card" id="loginCard">
      <h2>ğŸ”‘ ÄÄƒng nháº­p quáº£n trá»‹</h2>
      <input type="email" id="email" placeholder="Email admin" />
      <input type="password" id="password" placeholder="Máº­t kháº©u" />
      <button id="loginBtn">ÄÄƒng nháº­p</button>
      <p id="loginMsg" style="color:red;"></p>
    </div>

    <!-- Form Ä‘Äƒng bÃ i -->
    <div class="card" id="dangbaiCard" style="display:none;">
      <h2>ğŸ“¤ Viáº¿t bÃ i má»›i</h2>
      <form id="formDangBai">
        <input type="text" id="tieuDe" placeholder="TiÃªu Ä‘á»" required />
        <input type="text" id="tacGia" placeholder="TÃªn tÃ¡c giáº£" />

        <div style="margin:10px 0;">
          <label><input type="radio" name="loaiBai" value="noiBo" checked /> BÃ i viáº¿t ná»™i bá»™</label>
          <label style="margin-left:15px;"><input type="radio" name="loaiBai" value="ngoai" /> Link ngoÃ i</label>
        </div>

        <!-- Ná»™i bá»™ -->
        <div id="noiBoFields">
          <textarea id="noiDung" rows="8" placeholder="Ná»™i dung bÃ i bÃ¡o..."></textarea>
          <input type="file" id="anhBai" accept="image/*" />
          <div id="preview" style="margin-top:12px;"></div>
        </div>

        <!-- Link ngoÃ i -->
        <div id="ngoaiFields" style="display:none;">
          <input type="url" id="linkNgoai" placeholder="DÃ¡n link ngoÃ i (https://...)" />
        </div>

        <div style="margin-top:10px;">
          <button type="submit">ğŸ“Œ ÄÄƒng bÃ i</button>
        </div>
      </form>
    </div>

    <!-- Danh sÃ¡ch bÃ i -->
    <div class="card">
      <h2>ğŸ“° Danh sÃ¡ch bÃ i bÃ¡o</h2>
      <div id="dsBai"></div>
    </div>
  </section>

  <footer><p>Â© 2025 - Cáº£nh giÃ¡c cÃ¹ng chÃºng em</p></footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyA-w4aviFPK1-wtE_pVN01saRCq5bdgL9c",
      authDomain: "cungchungemcanhgiac.firebaseapp.com",
      projectId: "cungchungemcanhgiac",
      storageBucket: "cungchungemcanhgiac.appspot.com",
      messagingSenderId: "24327141155",
      appId: "1:24327141155:web:139b53155d697a7af87e96"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // DOM
    const loginCard = document.getElementById("loginCard");
    const dangbaiCard = document.getElementById("dangbaiCard");
    const loginBtn = document.getElementById("loginBtn");
    const loginMsg = document.getElementById("loginMsg");
    const emailEl = document.getElementById("email");
    const passEl = document.getElementById("password");

    // Ä‘Äƒng nháº­p
    loginBtn.addEventListener("click", async () => {
      try {
        await signInWithEmailAndPassword(auth, emailEl.value, passEl.value);
        loginMsg.textContent = "âœ… ÄÄƒng nháº­p thÃ nh cÃ´ng!";
      } catch (err) {
        loginMsg.textContent = "âŒ Sai tÃ i khoáº£n hoáº·c máº­t kháº©u!";
      }
    });

    // khi login thÃ nh cÃ´ng â†’ hiá»‡n form Ä‘Äƒng bÃ i
    onAuthStateChanged(auth, (user) => {
      if (user) {
        loginCard.style.display = "none";
        dangbaiCard.style.display = "block";
      } else {
        loginCard.style.display = "block";
        dangbaiCard.style.display = "none";
      }
    });

    // toggle loáº¡i bÃ i
    const noiBoFields = document.getElementById("noiBoFields");
    const ngoaiFields = document.getElementById("ngoaiFields");
    document.querySelectorAll('input[name="loaiBai"]').forEach(r => {
      r.addEventListener("change", () => {
        noiBoFields.style.display = r.value === "noiBo" ? "block" : "none";
        ngoaiFields.style.display = r.value === "ngoai" ? "block" : "none";
      });
    });

    // helper: file -> base64
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // form submit
    const form = document.getElementById("formDangBai");
    const tieuDeEl = document.getElementById("tieuDe");
    const tacGiaEl = document.getElementById("tacGia");
    const noiDungEl = document.getElementById("noiDung");
    const anhEl = document.getElementById("anhBai");
    const preview = document.getElementById("preview");
    const dsBai = document.getElementById("dsBai");

    anhEl.addEventListener("change", async () => {
      preview.innerHTML = "";
      if (anhEl.files[0]) {
        const b64 = await fileToBase64(anhEl.files[0]);
        const img = document.createElement("img");
        img.src = b64;
        img.style.maxWidth = "200px";
        preview.appendChild(img);
      }
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const tieuDe = tieuDeEl.value.trim();
      const tacGia = tacGiaEl.value.trim() || "Báº¡n Ä‘á»c";
      const loai = document.querySelector('input[name="loaiBai"]:checked').value;

      let noiDung = "";
      let anhBase64 = "";
      let linkNgoai = "";

      if (loai === "noiBo") {
        noiDung = noiDungEl.value.trim();
        if (!noiDung) {
          alert("Vui lÃ²ng nháº­p ná»™i dung.");
          return;
        }
        if (anhEl.files[0]) {
          anhBase64 = await fileToBase64(anhEl.files[0]);
        }
      } else if (loai === "ngoai") {
        linkNgoai = document.getElementById("linkNgoai").value.trim();
        if (!linkNgoai) {
          alert("Vui lÃ²ng nháº­p link ngoÃ i.");
          return;
        }
      }

      try {
        await addDoc(collection(db, "bai_bao"), {
          tieuDe,
          tacGia,
          noiDung,
          anhBase64,
          linkNgoai,
          loai,
          time: new Date()
        });
        alert("âœ… ÄÄƒng thÃ nh cÃ´ng!");
        form.reset();
        preview.innerHTML = "";
      } catch (err) {
        console.error(err);
        alert("âŒ Lá»—i khi Ä‘Äƒng bÃ i!");
      }
    });

    // hiá»ƒn thá»‹ danh sÃ¡ch
    const q = query(collection(db, "bai_bao"), orderBy("time", "desc"));
    onSnapshot(q, (snapshot) => {
      dsBai.innerHTML = "";
      snapshot.forEach((doc) => {
        const data = doc.data();
        const timeStr = data.time?.toDate ? data.time.toDate().toLocaleString("vi-VN") : "";
        let link = "";
        let icon = data.loai === "ngoai" ? "ğŸ”—" : "ğŸ“„";

        if (data.loai === "ngoai" && data.linkNgoai) {
          link = `<a href="${data.linkNgoai}" target="_blank">${escapeHtml(data.tieuDe || "")}</a>`;
        } else {
          link = `<a href="baibao.html?id=${doc.id}">${escapeHtml(data.tieuDe || "")}</a>`;
        }

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <h3>${icon} ${link}</h3>
          <small>âœï¸ ${escapeHtml(data.tacGia || "")} â€” ${timeStr}</small>
          <p style="white-space:pre-wrap;">${escapeHtml((data.noiDung || "").slice(0, 200))}</p>
        `;
        dsBai.appendChild(card);
      });
    });

    function escapeHtml(t) {
      return t ? t.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;") : "";
    }
  </script>
</body>
</html>
