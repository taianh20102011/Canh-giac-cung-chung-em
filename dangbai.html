<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Đăng bài - Cảnh giác cùng chúng em</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <h1>📝 Góc Báo chí học sinh</h1>
    <p>Chia sẻ thông tin và tuyên truyền</p>
  </header>

  <nav>
    <a href="index.html">Trang chủ</a>
    <a href="chieutro.html">Thủ đoạn</a>
    <a href="5khong5nen.html">5 KHÔNG - 5 NÊN</a>
    <a href="phanung.html">Phản ứng nhanh</a>
    <a href="sangtao.html">Sáng tạo</a>
    <a href="tracnghiem.html">Trắc nghiệm</a>
    <a href="tuongtac.html">Tương tác</a>
    <a href="dangbai.html">Đăng bài</a>
  </nav>

  <section>
    <!-- Mật khẩu admin -->
    <div class="card" id="loginCard">
      <h2>🔐 Chỉ quản trị viên được đăng bài</h2>
      <input type="password" id="adminPass" placeholder="Nhập mật khẩu..." />
      <button id="checkPass">Xác nhận</button>
      <p id="loginMsg" style="color:red;"></p>
    </div>

    <!-- Form đăng bài -->
    <div class="card" id="dangbaiCard" style="display:none;">
      <h2>📤 Viết bài mới</h2>
      <form id="formDangBai">
        <input type="text" id="tieuDe" placeholder="Tiêu đề" required />
        <input type="text" id="tacGia" placeholder="Tên tác giả" />

        <div style="margin:10px 0;">
          <label><input type="radio" name="loaiBai" value="noiBo" checked /> Bài viết nội bộ</label>
          <label style="margin-left:15px;"><input type="radio" name="loaiBai" value="ngoai" /> Link ngoài</label>
        </div>

        <!-- Nội dung bài viết -->
        <div id="noiBoFields">
          <textarea id="noiDung" rows="8" placeholder="Nội dung bài báo..."></textarea>
          <input type="file" id="anhBai" accept="image/*" />
          <div id="preview" style="margin-top:12px;"></div>
        </div>

        <!-- Link ngoài -->
        <div id="ngoaiFields" style="display:none;">
          <input type="url" id="linkNgoai" placeholder="Dán link ngoài (ví dụ: https://chinhphu.vn/...)" />
        </div>

        <div style="margin-top:10px;">
          <button type="submit">📌 Đăng bài</button>
        </div>
      </form>
    </div>

    <!-- Danh sách bài -->
    <div class="card">
      <h2>📰 Danh sách bài báo</h2>
      <div id="dsBai"></div>
    </div>
  </section>

  <footer><p>© 2025 - Cảnh giác cùng chúng em</p></footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // 🔑 Mật khẩu admin
    const ADMIN_PASS = "canhgiaccungchungem_lytutrong_anhoidong"; // đổi mật khẩu tại đây

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyA-w4aviFPK1-wtE_pVN01saRCq5bdgL9c",
      authDomain: "cungchungemcanhgiac.firebaseapp.com",
      projectId: "cungchungemcanhgiac",
      storageBucket: "cungchungemcanhgiac.appspot.com",
      messagingSenderId: "24327141155",
      appId: "1:24327141155:web:139b53155d697a7af87e96"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // DOM
    const loginCard = document.getElementById("loginCard");
    const dangbaiCard = document.getElementById("dangbaiCard");
    const passInput = document.getElementById("adminPass");
    const checkPassBtn = document.getElementById("checkPass");
    const loginMsg = document.getElementById("loginMsg");

    // check pass
    checkPassBtn.addEventListener("click", () => {
      if (passInput.value === ADMIN_PASS) {
        loginCard.style.display = "none";
        dangbaiCard.style.display = "block";
      } else {
        loginMsg.textContent = "❌ Sai mật khẩu!";
      }
    });

    // toggle loại bài
    const noiBoFields = document.getElementById("noiBoFields");
    const ngoaiFields = document.getElementById("ngoaiFields");
    document.querySelectorAll('input[name="loaiBai"]').forEach(r => {
      r.addEventListener("change", () => {
        if (r.value === "noiBo" && r.checked) {
          noiBoFields.style.display = "block";
          ngoaiFields.style.display = "none";
        }
        if (r.value === "ngoai" && r.checked) {
          noiBoFields.style.display = "none";
          ngoaiFields.style.display = "block";
        }
      });
    });

    // helper: file -> base64
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // form submit
    const form = document.getElementById("formDangBai");
    const tieuDeEl = document.getElementById("tieuDe");
    const tacGiaEl = document.getElementById("tacGia");
    const noiDungEl = document.getElementById("noiDung");
    const anhEl = document.getElementById("anhBai");
    const preview = document.getElementById("preview");
    const dsBai = document.getElementById("dsBai");

    anhEl.addEventListener("change", async () => {
      preview.innerHTML = "";
      if (anhEl.files[0]) {
        const b64 = await fileToBase64(anhEl.files[0]);
        const img = document.createElement("img");
        img.src = b64;
        img.style.maxWidth = "200px";
        preview.appendChild(img);
      }
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const tieuDe = tieuDeEl.value.trim();
      const tacGia = tacGiaEl.value.trim() || "Bạn đọc";
      const loai = document.querySelector('input[name="loaiBai"]:checked').value;

      let noiDung = "";
      let anhBase64 = "";
      let linkNgoai = "";

      if (loai === "noiBo") {
        noiDung = noiDungEl.value.trim();
        if (!noiDung) {
          alert("Vui lòng nhập nội dung.");
          return;
        }
        if (anhEl.files[0]) {
          anhBase64 = await fileToBase64(anhEl.files[0]);
        }
      } else if (loai === "ngoai") {
        linkNgoai = document.getElementById("linkNgoai").value.trim();
        if (!linkNgoai) {
          alert("Vui lòng nhập link ngoài.");
          return;
        }
      }

      try {
        await addDoc(collection(db, "bai_bao"), {
          tieuDe,
          tacGia,
          noiDung,
          anhBase64,
          linkNgoai,
          loai,
          time: new Date()
        });
        alert("✅ Đăng thành công!");
        form.reset();
        preview.innerHTML = "";
        noiBoFields.style.display = "block";
        ngoaiFields.style.display = "none";
      } catch (err) {
        console.error(err);
        alert("❌ Lỗi khi đăng bài!");
      }
    });

    // hiển thị danh sách
    const q = query(collection(db, "bai_bao"), orderBy("time", "desc"));
    onSnapshot(q, (snapshot) => {
      dsBai.innerHTML = "";
      snapshot.forEach((doc) => {
        const data = doc.data();
        const timeStr = data.time?.toDate ? data.time.toDate().toLocaleString("vi-VN") : "";
        let link = "";
        let icon = data.loai === "ngoai" ? "🔗" : "📄";

        if (data.loai === "ngoai" && data.linkNgoai) {
          link = `<a href="${data.linkNgoai}" target="_blank">${escapeHtml(data.tieuDe || "")}</a>`;
        } else {
          link = `<a href="baibao.html?id=${doc.id}">${escapeHtml(data.tieuDe || "")}</a>`;
        }

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <h3>${icon} ${link}</h3>
          <small>✍️ ${escapeHtml(data.tacGia || "")} — ${timeStr}</small>
          <p style="white-space:pre-wrap;">${escapeHtml((data.noiDung || "").slice(0, 200))}</p>
        `;
        dsBai.appendChild(card);
      });
    });

    function escapeHtml(t) {
      return t ? t.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;") : "";
    }
  </script>
</body>
</html>
